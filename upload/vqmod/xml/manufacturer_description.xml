<!-- Created using vQmod XML Generator by UKSB - http://uksb.github.com/vqgen/ //-->
<modification>
	<id><![CDATA[Manufacturer description]]></id>
	<version><![CDATA[0.3]]></version>
	<vqmver><![CDATA[2.3.0]]></vqmver>
	<author><![CDATA[<Lev Ananikyan> lev.ananikyan@gmail.com]]></author>
	<file name="admin/controller/catalog/manufacturer.php">
		<operation info="Install table">
			<search position="after"><![CDATA[public function index() {]]></search>
			<add><![CDATA[  		
		$query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "setting` WHERE `key` = 'config_image_manufacturer_width'");
		$setting_exists = $query->num_rows > 0;
		if(!$setting_exists){
			$this->db->query("INSERT INTO `" . DB_PREFIX ."setting` (`group`, `key`, `value`, `serialized`) VALUES ('config', 'config_image_manufacturer_width', '100', '0')");
		}
		
		$query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "setting` WHERE `key` = 'config_image_manufacturer_height'");
		$setting_exists = $query->num_rows > 0;
		if(!$setting_exists){
			$this->db->query("INSERT INTO `" . DB_PREFIX ."setting` (`group`, `key`, `value`, `serialized`) VALUES ('config', 'config_image_manufacturer_height', '100', '0')");
		}
		$query = $this->db->query("SHOW TABLES LIKE '" . DB_PREFIX . "manufacturer_description'");
  		$table_exists = $query->num_rows > 0;
  		if(!$table_exists){
  			$this->db->query("CREATE TABLE IF NOT EXISTS `" . DB_PREFIX . "manufacturer_description` 
  							(
							  `manufacturer_id` int(11) NOT NULL AUTO_INCREMENT,
							  `language_id` int(11) NOT NULL,
							  `description` text COLLATE utf8_bin NOT NULL,
							  `meta_description` varchar(255) COLLATE utf8_bin NOT NULL,
							  `meta_keywords` varchar(255) COLLATE utf8_bin NOT NULL,
  							  `page_title` varchar(255) COLLATE utf8_bin NOT NULL,
							  PRIMARY KEY (`manufacturer_id`,`language_id`)
							) 
  					ENGINE=MyISAM  DEFAULT CHARSET=utf8 COLLATE=utf8_bin;");
  		}]]></add>
		</operation>
		<operation info="Add labels lang values">
			<search position="after"><![CDATA[$this->data['entry_name'] = $this->language->get('entry_name');]]></search>
			<add><![CDATA[		$this->data['entry_meta_description'] = $this->language->get('entry_meta_description');
		$this->data['entry_meta_keywords'] = $this->language->get('entry_meta_keywords');
		$this->data['entry_description'] = $this->language->get('entry_description');
		$this->data['entry_page_title'] = $this->language->get('entry_page_title');
		]]></add>
		</operation>
		<operation info="Set values">
			<search position="before"><![CDATA[if (isset($this->request->post['name'])) {]]></search>
			<add><![CDATA[		$this->load->model('localisation/language');
		$this->data['languages'] = $this->model_localisation_language->getLanguages();

		if (isset($this->request->post['manufacturer_description'])) {
			$this->data['manufacturer_description'] = $this->request->post['manufacturer_description'];
		} elseif (isset($manufacturer_info)) {
			$this->data['manufacturer_description'] = $this->model_catalog_manufacturer->getManufacturerDescriptions($this->request->get['manufacturer_id']);
		} else {
			$this->data['manufacturer_description'] = array();
		}]]></add>
		</operation>
	</file>
	<file name="admin/model/catalog/manufacturer.php">
		<operation>
			<search position="before" offset="1"><![CDATA[if (isset($data['manufacturer_store'])) {]]></search>
			<add><![CDATA[		if (isset($data['manufacturer_description'])) {
			foreach ($data['manufacturer_description'] as $language_id => $value) {
				$this->db->query("INSERT INTO " . DB_PREFIX . "manufacturer_description SET manufacturer_id = '" . (int)$manufacturer_id . "', language_id = '" . (int)$language_id . "', meta_description = '" . $this->db->escape($value['meta_description']) . "', meta_keywords = '" . $this->db->escape($value['meta_keywords']) . "', description = '" . $this->db->escape($value['description']) . "', page_title = '" . $this->db->escape($value['page_title']) . "'");
			}
		}]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "manufacturer_to_store WHERE manufacturer_id = '" . (int)$manufacturer_id . "'");]]></search>
			<add><![CDATA[		$this->db->query("DELETE FROM " . DB_PREFIX . "manufacturer_description WHERE manufacturer_id = '" . (int)$manufacturer_id . "'");]]></add>
		</operation>
		<operation>
			<search position="before" offset="1"><![CDATA[?>]]></search>
			<add><![CDATA[	
	public function getManufacturerDescriptions($manufacturer_id) {
		$manufacturer_description_data = array();
		
		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "manufacturer_description WHERE manufacturer_id = '" . (int)$manufacturer_id . "'");
		
		foreach ($query->rows as $result) {
			$manufacturer_description_data[$result['language_id']] = array(
				'meta_description' => $result['meta_description'],
				'meta_keywords' => $result['meta_keywords'],
				'description'      => $result['description'],
				'page_title'      => $result['page_title']
			);
		}
		
		return $manufacturer_description_data;
	}]]></add>
		</operation>
	</file>
	<file name="admin/view/template/catalog/manufacturer_form.tpl">
		<operation info="Replace template">
			<search position="all"><![CDATA[]]></search>
			<add><![CDATA[<?php echo $header; ?>
<div id="content">
  <div class="breadcrumb">
    <?php foreach ($breadcrumbs as $breadcrumb) { ?>
    <?php echo $breadcrumb['separator']; ?><a href="<?php echo $breadcrumb['href']; ?>"><?php echo $breadcrumb['text']; ?></a>
    <?php } ?>
  </div>
  <?php if ($error_warning) { ?>
  <div class="warning"><?php echo $error_warning; ?></div>
  <?php } ?>
  <div class="box">
    <div class="heading">
      <h1><img src="view/image/shipping.png" alt="" /> <?php echo $heading_title; ?></h1>
      <div class="buttons"><a onclick="$('#form').submit();" class="button"><?php echo $button_save; ?></a><a href="<?php echo $cancel; ?>" class="button"><?php echo $button_cancel; ?></a></div>
    </div>
    <div class="content">
      <div id="tabs" class="htabs"><a href="#tab-general"><?php echo $tab_general; ?></a></div>
      <form action="<?php echo $action; ?>" method="post" enctype="multipart/form-data" id="form">
        <div id="tab-general">
          <table class="form">
            <tr>
              <td><span class="required">*</span> <?php echo $entry_name; ?></td>
              <td><input type="text" name="name" value="<?php echo $name; ?>" size="100" />
                <?php if ($error_name) { ?>
                <span class="error"><?php echo $error_name; ?></span>
                <?php } ?></td>
            </tr>           
            <tr>
              <td><?php echo $entry_keyword; ?></td>
              <td><input type="text" name="keyword" value="<?php echo $keyword; ?>" /></td>
            </tr>
            <tr>
              <td><?php echo $entry_image; ?></td>
              <td valign="top"><div class="image"><img src="<?php echo $thumb; ?>" alt="" id="thumb" />
                <input type="hidden" name="image" value="<?php echo $image; ?>" id="image" />
                <br /><a onclick="image_upload('image', 'thumb');"><?php echo $text_browse; ?></a>&nbsp;&nbsp;|&nbsp;&nbsp;<a onclick="$('#thumb').attr('src', '<?php echo $no_image; ?>'); $('#image').attr('value', '');"><?php echo $text_clear; ?></a></div></td>
            </tr>
			<tr>
			  <td colspan="2">
				<div id="languages" class="htabs">
					<?php foreach ($languages as $language) { ?>
					<a href="#language<?php echo $language['language_id']; ?>"><img src="view/image/flags/<?php echo $language['image']; ?>" title="<?php echo $language['name']; ?>" /> <?php echo $language['name']; ?></a>
					<?php } ?>
				</div>
				<?php foreach ($languages as $language) { ?>
				<div id="language<?php echo $language['language_id']; ?>">
					<table class="form">
						<tr>
						  <td><?php echo $entry_page_title; ?></td>
						  <td><input type="text" name="manufacturer_description[<?php echo $language['language_id']; ?>][page_title]" id="page_title<?php echo $language['language_id']; ?>" value="<?php echo isset($manufacturer_description[$language['language_id']]) ? $manufacturer_description[$language['language_id']]['page_title'] : ''; ?>" size="100"></td>
						</tr>
						<tr>
						  <td><?php echo $entry_meta_description; ?></td>
						  <td><textarea name="manufacturer_description[<?php echo $language['language_id']; ?>][meta_description]" cols="50" rows="3"><?php echo isset($manufacturer_description[$language['language_id']]) ? $manufacturer_description[$language['language_id']]['meta_description'] : ''; ?></textarea></td>
						</tr>
						<tr>
						  <td><?php echo $entry_meta_keywords; ?></td>
						  <td><textarea name="manufacturer_description[<?php echo $language['language_id']; ?>][meta_keywords]" cols="50" rows="2"><?php echo isset($manufacturer_description[$language['language_id']]) ? $manufacturer_description[$language['language_id']]['meta_keywords'] : ''; ?></textarea></td>
						</tr>
						<tr>
						  <td><?php echo $entry_description; ?></td>
						  <td><textarea name="manufacturer_description[<?php echo $language['language_id']; ?>][description]" id="description<?php echo $language['language_id']; ?>"><?php echo isset($manufacturer_description[$language['language_id']]) ? $manufacturer_description[$language['language_id']]['description'] : ''; ?></textarea></td>
						</tr>
					</table>
				</div>
				<?php } ?>
			  </td>
			</tr>
            <tr>
              <td><?php echo $entry_sort_order; ?></td>
              <td><input type="text" name="sort_order" value="<?php echo $sort_order; ?>" size="1" /></td>
            </tr>
			<tr>
              <td><?php echo $entry_store; ?></td>
              <td><div class="scrollbox">
                  <?php $class = 'even'; ?>
                  <div class="<?php echo $class; ?>">
                    <?php if (in_array(0, $manufacturer_store)) { ?>
                    <input type="checkbox" name="manufacturer_store[]" value="0" checked="checked" />
                    <?php echo $text_default; ?>
                    <?php } else { ?>
                    <input type="checkbox" name="manufacturer_store[]" value="0" />
                    <?php echo $text_default; ?>
                    <?php } ?>
                  </div>
                  <?php foreach ($stores as $store) { ?>
                  <?php $class = ($class == 'even' ? 'odd' : 'even'); ?>
                  <div class="<?php echo $class; ?>">
                    <?php if (in_array($store['store_id'], $manufacturer_store)) { ?>
                    <input type="checkbox" name="manufacturer_store[]" value="<?php echo $store['store_id']; ?>" checked="checked" />
                    <?php echo $store['name']; ?>
                    <?php } else { ?>
                    <input type="checkbox" name="manufacturer_store[]" value="<?php echo $store['store_id']; ?>" />
                    <?php echo $store['name']; ?>
                    <?php } ?>
                  </div>
                  <?php } ?>
                </div></td>
            </tr>
          </table>
        </div>
      </form>
    </div>
  </div>
</div>
<script type="text/javascript"><!--
function image_upload(field, thumb) {
	$('#dialog').remove();
	
	$('#content').prepend('<div id="dialog" style="padding: 3px 0px 0px 0px;"><iframe src="index.php?route=common/filemanager&token=<?php echo $token; ?>&field=' + encodeURIComponent(field) + '" style="padding:0; margin: 0; display: block; width: 100%; height: 100%;" frameborder="no" scrolling="auto"></iframe></div>');
	
	$('#dialog').dialog({
		title: '<?php echo $text_image_manager; ?>',
		close: function (event, ui) {
			if ($('#' + field).attr('value')) {
				$.ajax({
					url: 'index.php?route=common/filemanager/image&token=<?php echo $token; ?>&image=' + encodeURIComponent($('#' + field).val()),
					dataType: 'text',
					success: function(data) {
						$('#' + thumb).replaceWith('<img src="' + data + '" alt="" id="' + thumb + '" />');
					}
				});
			}
		},	
		bgiframe: false,
		width: 800,
		height: 400,
		resizable: false,
		modal: false
	});
};
//--></script> 

<script type="text/javascript" src="view/javascript/ckeditor/ckeditor.js"></script> 
<script type="text/javascript"><!--
<?php foreach ($languages as $language) { ?>
CKEDITOR.replace('description<?php echo $language['language_id']; ?>', {
	filebrowserBrowseUrl: 'index.php?route=common/filemanager&token=<?php echo $token; ?>',
	filebrowserImageBrowseUrl: 'index.php?route=common/filemanager&token=<?php echo $token; ?>',
	filebrowserFlashBrowseUrl: 'index.php?route=common/filemanager&token=<?php echo $token; ?>',
	filebrowserUploadUrl: 'index.php?route=common/filemanager&token=<?php echo $token; ?>',
	filebrowserImageUploadUrl: 'index.php?route=common/filemanager&token=<?php echo $token; ?>',
	filebrowserFlashUploadUrl: 'index.php?route=common/filemanager&token=<?php echo $token; ?>'
});
<?php } ?>
//--></script> 

<script type="text/javascript"><!--
$('#tabs a').tabs();
$('#languages a').tabs(); 
//--></script> 
<?php echo $footer; ?>]]></add>
		</operation>
	</file>
	<file path="admin/controller/setting/" name="store.php,setting.php">
		<operation>
			<search position="after"><![CDATA[$this->data['entry_image_category'] = $this->language->get('entry_image_category');]]></search>
			<add><![CDATA[		$this->data['entry_image_manufacturer'] = $this->language->get('entry_image_manufacturer');]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[if (isset($this->error['image_thumb'])) {]]></search>
			<add><![CDATA[		
		if (isset($this->error['image_manufacturer'])) {
			$this->data['error_image_manufacturer'] = $this->error['image_manufacturer'];
		} else {
			$this->data['error_image_manufacturer'] = '';
		}
		]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[if (isset($this->request->post['config_image_thumb_width'])) {]]></search>
			<add><![CDATA[		if (isset($this->request->post['config_image_manufacturer_width'])) {
			$this->data['config_image_manufacturer_width'] = $this->request->post['config_image_manufacturer_width'];
		} else {
			$this->data['config_image_manufacturer_width'] = $this->config->get('config_image_manufacturer_width');
		}
		
		if (isset($this->request->post['config_image_manufacturer_height'])) {
			$this->data['config_image_manufacturer_height'] = $this->request->post['config_image_manufacturer_height'];
		} else {
			$this->data['config_image_manufacturer_height'] = $this->config->get('config_image_manufacturer_height');
		}
]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[if (!$this->request->post['config_image_thumb_width'] || !$this->request->post['config_image_thumb_height']) {]]></search>
			<add><![CDATA[		if (!$this->request->post['config_image_manufacturer_width'] || !$this->request->post['config_image_manufacturer_height']) {
			$this->error['image_manufacturer'] = $this->language->get('error_image_manufacturer');
		}
]]></add>
		</operation>
	</file>
	<file name="admin/language/english/catalog/manufacturer.php">
		<operation info="Labels lang values">
			<search position="after"><![CDATA[$_['entry_image']        = 'Image:';]]></search>
			<add><![CDATA[$_['entry_meta_description']= 'Meta Tag Description:';
$_['entry_meta_keywords']= 'Meta Tag Keywords:';
$_['entry_description']  = 'Description:';
$_['entry_page_title']   = 'Page Title:';]]></add>
		</operation>
	</file>
	<file path="admin/language/english/setting/" name="store.php,setting.php">
		<operation info="Lang values">
			<search position="after"><![CDATA[$_['entry_image_category']         = 'Category Image Size:';]]></search>
			<add><![CDATA[$_['entry_image_manufacturer']     = 'Manufacturer Image Size:';]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[$_['error_image_category']         = 'Category List Size dimensions required!';]]></search>
			<add><![CDATA[$_['error_image_manufacturer']     = 'Manufacturer List Size dimensions required!';]]></add>
		</operation>
	</file>
	<file path="admin/view/template/setting/" name="store_form.tpl,setting.tpl">
		<operation>
			<search position="before" offset="1"><![CDATA[<td><span class="required">*</span> <?php echo $entry_image_thumb; ?></td>]]></search>
			<add><![CDATA[            <tr>
              <td><span class="required">*</span> <?php echo $entry_image_manufacturer; ?></td>
              <td><input type="text" name="config_image_manufacturer_width" value="<?php echo $config_image_manufacturer_width; ?>" size="3" />
                x
                <input type="text" name="config_image_manufacturer_height" value="<?php echo $config_image_manufacturer_height; ?>" size="3" />
                <?php if ($error_image_manufacturer) { ?>
                <span class="error"><?php echo $error_image_manufacturer; ?></span>
                <?php } ?></td>
            </tr>]]></add>
		</operation>
	</file>
	<file name="catalog/controller/product/manufacturer.php">
		<operation info="Set manufacturer info">
			<search position="replace"><![CDATA[$this->document->setTitle($manufacturer_info['name']);]]></search>
			<add><![CDATA[			if(!empty($manufacturer_info['page_title'])){
				$this->document->setTitle($manufacturer_info['page_title']);
			}
			else{
				$this->document->setTitle($manufacturer_info['name']);
			}
			if(isset($manufacturer_info['meta_description'])){
				$this->document->setDescription($manufacturer_info['meta_description']);
			}
			if(isset($manufacturer_info['meta_keywords'])){
				$this->document->setKeywords($manufacturer_info['meta_keywords']);
			}]]></add>
		</operation>
		<operation info="Set manufacturer info">
			<search position="after"><![CDATA[$this->data['heading_title'] = $manufacturer_info['name'];]]></search>
			<add><![CDATA[			$this->data['manufacturer_name'] = $manufacturer_info['name'];
			
			if(!empty($manufacturer_info['description'])){
				$this->data['description'] = html_entity_decode($manufacturer_info['description'], ENT_QUOTES, 'UTF-8');
			}
			$this->data['thumb'] = $this->model_tool_image->resize($manufacturer_info["image"], $this->config->get('config_image_manufacturer_width'), $this->config->get('config_image_manufacturer_height'));
]]></add>
		</operation>
	</file>
	<file name="catalog/model/catalog/manufacturer.php">
		<operation>
			<search position="replace"><![CDATA[$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "manufacturer m LEFT JOIN " . DB_PREFIX . "manufacturer_to_store m2s ON (m.manufacturer_id = m2s.manufacturer_id) WHERE m.manufacturer_id = '" . (int)$manufacturer_id . "' AND m2s.store_id = '" . (int)$this->config->get('config_store_id') . "'");]]></search>
			<add><![CDATA[		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "manufacturer m
		LEFT JOIN " . DB_PREFIX . "manufacturer_description md ON (m.manufacturer_id = md.manufacturer_id)
		LEFT JOIN " . DB_PREFIX . "manufacturer_to_store m2s ON (m.manufacturer_id = m2s.manufacturer_id)
		WHERE m.manufacturer_id = '" . (int)$manufacturer_id . "'
		AND md.language_id = '" . (int)$this->config->get('config_language_id') . "'
		AND m2s.store_id = '" . (int)$this->config->get('config_store_id') . "'");
		if($query->num_rows){
			return $query->row;
		}		
		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "manufacturer m 
		LEFT JOIN " . DB_PREFIX . "manufacturer_to_store m2s ON (m.manufacturer_id = m2s.manufacturer_id) 
		WHERE m.manufacturer_id = '" . (int)$manufacturer_id . "' 
		AND m2s.store_id = '" . (int)$this->config->get('config_store_id') . "'");	
		]]></add>
		</operation>
	</file>
	<file name="catalog/view/theme/*/template/product/manufacturer_info.tpl">
		<operation>
			<search position="after"><![CDATA[<h1><?php echo $heading_title; ?></h1>]]></search>
			<add><![CDATA[  <?php if (!empty($description)) { ?>
    <div class="manufacturer-info">
     <div class="image"><img src="<?php echo $thumb; ?>" title="<?php echo $manufacturer_name; ?>" alt="<?php echo $manufacturer_name; ?>" /></div>
    <?php echo $description; ?>
    </div>
  <?php } ?>]]></add>
		</operation>
	</file>
	<file name="catalog/view/theme/*/template/common/header.tpl">
		<operation info="Css">
			<search position="before"><![CDATA[</head>]]></search>
			<add><![CDATA[<style type="text/css">
/* Manufacturer info*/
.manufacturer-info {
	overflow: auto;
	margin-bottom: 20px;
}
.manufacturer-info .image {
	float: left;
	padding: 5px;
	margin-right: 15px;
	border: 1px solid #E7E7E7;
}
</style>]]></add>
		</operation>
	</file>
</modification>